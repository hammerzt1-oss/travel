# 后端工程师 - 上线任务

## 🎯 你的任务：部署后端到Railway/Render

**预计时间：** 30-40分钟
**优先级：** 最高（必须先完成）

---

## 📋 执行步骤

### Step 1：选择部署平台（5分钟）

**方案A：Railway（推荐）**
- 免费额度充足
- 自动部署
- 环境变量管理方便

**方案B：Render**
- 免费套餐可用
- 自动HTTPS
- 简单易用

**选择其中一个即可**

---

### Step 2：部署到Railway（如果选择Railway）

**步骤：**

1. **创建账号**
   - 访问 https://railway.app
   - 使用GitHub账号登录

2. **创建项目**
   - 点击 "New Project"
   - 选择 "Deploy from GitHub repo"
   - 选择项目仓库

3. **配置服务**
   - Railway会自动检测Node.js项目
   - 确认Root Directory是 `backend`
   - 确认Start Command是 `npm start`

4. **配置环境变量**
   - 进入项目 → Variables标签
   - 添加变量：
     - **OTA_PID：** `284116645`
     - **NODE_ENV：** `production`
   - PORT会自动配置，无需手动设置

5. **部署**
   - Railway会自动部署
   - 等待部署完成（约2-3分钟）
   - 获取部署URL（如：https://xxx.railway.app）

---

### Step 3：部署到Render（如果选择Render）

**步骤：**

1. **创建账号**
   - 访问 https://render.com
   - 使用GitHub账号登录

2. **创建Web Service**
   - 点击 "New" → "Web Service"
   - 连接GitHub仓库

3. **配置服务**
   - **Name：** travel-backend
   - **Environment：** Node
   - **Build Command：** `cd backend && npm install`
   - **Start Command：** `cd backend && npm start`
   - **Root Directory：** backend

4. **配置环境变量**
   - 进入服务 → Environment标签
   - 添加变量：
     - **Key：** `OTA_PID`, **Value：** `284116645`
     - **Key：** `NODE_ENV`, **Value：** `production`

5. **部署**
   - 点击 "Create Web Service"
   - 等待部署完成（约3-5分钟）
   - 获取部署URL

---

### Step 4：验证部署（10分钟）

**验证项：**

1. **健康检查**
   - [ ] 访问 `https://你的后端URL/health`
   - [ ] 应该返回：`{"status":"ok","timestamp":"..."}`
   - [ ] 状态码200

2. **API验证**
   - [ ] 访问 `https://你的后端URL/api/recommendations?type=week`
   - [ ] 应该返回推荐列表数据
   - [ ] 检查返回的OTA URL是否完整
   - [ ] 确认URL包含PID参数（284116645）

3. **详情API验证**
   - [ ] 访问 `https://你的后端URL/api/destinations/1`
   - [ ] 应该返回目的地详情
   - [ ] 检查 `cta_links` 是否包含完整URL
   - [ ] 确认所有链接都包含PID

4. **环境变量验证**
   - [ ] 检查日志，确认没有"未配置OTA_PID"警告
   - [ ] 确认PID正确（不是YOUR_PID或TEST_PID）

---

## ✅ 完成标准

**必须全部通过：**
- [ ] 部署成功
- [ ] `/health` 返回200
- [ ] API能正常返回数据
- [ ] OTA链接包含正确PID
- [ ] 环境变量配置正确

---

## 📞 如果遇到问题

**部署失败：**
- 检查构建日志
- 检查环境变量配置
- 检查代码是否有错误

**API返回错误：**
- 检查环境变量是否正确
- 检查数据文件是否存在
- 检查服务日志

**OTA链接不正确：**
- 检查 `OTA_PID` 环境变量
- 确认PID是 `284116645`
- 检查链接生成逻辑

**直接说：**
- "后端已部署，/health OK，URL是XXX"
- "后端已部署，但/health返回XXX"
- "后端部署失败，错误是XXX"

---

## ⚠️ 重要提醒

1. **必须先部署后端**
   - 前端需要后端URL
   - 必须先完成后端部署

2. **环境变量必须配置**
   - `OTA_PID=284116645`（使用真实PID）
   - `NODE_ENV=production`
   - 不要使用TEST_PID

3. **部署后立即验证**
   - 不要部署完就走
   - 必须验证API正常
   - 必须验证OTA链接正确

4. **获取后端URL**
   - 部署完成后，获取完整的后端URL
   - 提供给前端工程师
   - 格式：`https://xxx.railway.app` 或 `https://xxx.onrender.com`

---

## 🎯 下一步

**部署完成后：**
1. **通知前端工程师：** 后端已部署，URL是XXX
2. **等待前端部署：** 前端需要你的URL
3. **配合验证：** 完成Step 3和Step 4的验证

---

## 📝 需要提供给前端的信息

**部署完成后，提供以下信息：**
- 后端URL：`https://xxx.railway.app`
- 健康检查URL：`https://xxx.railway.app/health`
- 状态：已部署，/health OK

---

**开始时间：现在**
**预计时间：30-40分钟**
**负责人：后端工程师**

