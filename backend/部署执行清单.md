# 后端部署执行清单

## 🎯 任务目标

部署后端到Railway或Render，获取生产环境URL。

**预计时间：** 30-40分钟

---

## 📋 执行步骤

### Step 1：选择平台（2分钟）

**推荐：Railway**（免费额度充足，自动部署）

**备选：Render**（免费套餐可用）

---

### Step 2：Railway部署（如果选择Railway）

#### 2.1 创建账号（2分钟）
- [ ] 访问 https://railway.app
- [ ] 使用GitHub账号登录
- [ ] 授权Railway访问GitHub仓库

#### 2.2 创建项目（3分钟）
- [ ] 点击 "New Project"
- [ ] 选择 "Deploy from GitHub repo"
- [ ] 选择项目仓库（travel）
- [ ] 点击 "Deploy Now"

#### 2.3 配置服务（5分钟）
- [ ] 进入服务设置
- [ ] 设置 **Root Directory：** `backend` ⚠️ **重要**
- [ ] 确认 Start Command：`npm start`
- [ ] 确认 Build Command：`npm install`

#### 2.4 配置环境变量（5分钟）
- [ ] 进入项目 → 服务 → "Variables" 标签
- [ ] 添加环境变量：
  - **Key：** `OTA_PID`，**Value：** `284116645`
  - **Key：** `NODE_ENV`，**Value：** `production`
- [ ] 保存（会自动重新部署）

#### 2.5 等待部署（3-5分钟）
- [ ] 查看部署日志
- [ ] 等待部署完成
- [ ] 获取部署URL（如：`https://xxx.railway.app`）

---

### Step 3：Render部署（如果选择Render）

#### 3.1 创建账号（2分钟）
- [ ] 访问 https://render.com
- [ ] 使用GitHub账号登录
- [ ] 授权Render访问GitHub仓库

#### 3.2 创建Web Service（5分钟）
- [ ] 点击 "New" → "Web Service"
- [ ] 选择项目仓库（travel）
- [ ] 点击 "Connect"

#### 3.3 配置服务（5分钟）
- [ ] **Name：** `travel-backend`
- [ ] **Environment：** `Node`
- [ ] **Root Directory：** `backend` ⚠️ **重要**
- [ ] **Build Command：** `cd backend && npm install`
- [ ] **Start Command：** `cd backend && npm start`

#### 3.4 配置环境变量（5分钟）
- [ ] 找到 "Environment Variables"
- [ ] 添加变量：
  - **Key：** `OTA_PID`，**Value：** `284116645`
  - **Key：** `NODE_ENV`，**Value：** `production`

#### 3.5 部署（3-5分钟）
- [ ] 点击 "Create Web Service"
- [ ] 等待部署完成
- [ ] 获取部署URL（如：`https://travel-backend.onrender.com`）

---

### Step 4：验证部署（10分钟）

#### 4.1 健康检查
- [ ] 访问：`https://你的URL/health`
- [ ] 应该返回：
```json
{
  "status": "ok",
  "timestamp": "...",
  "service": "travel-backend",
  "version": "1.0.0"
}
```
- [ ] 状态码：200 ✅

#### 4.2 API验证
- [ ] 访问：`https://你的URL/api/recommendations?type=week`
- [ ] 应该返回推荐列表数据
- [ ] 检查返回的 `cta_links` 是否包含完整URL
- [ ] 确认URL包含PID参数（284116645）

#### 4.3 详情API验证
- [ ] 访问：`https://你的URL/api/destinations/1`
- [ ] 应该返回目的地详情
- [ ] 检查 `cta_links` 是否包含完整URL
- [ ] 确认所有链接都包含PID（284116645）

#### 4.4 环境变量验证
- [ ] 检查部署日志，确认没有"未配置OTA_PID"警告
- [ ] 确认PID正确（不是YOUR_PID或TEST_PID）

---

## ✅ 完成标准

**必须全部通过：**
- [ ] 部署成功
- [ ] `/health` 返回200
- [ ] API能正常返回数据
- [ ] OTA链接包含正确PID（284116645）
- [ ] 环境变量配置正确

---

## 📝 部署完成后

**必须提供以下信息：**

1. **后端URL：** `https://xxx.railway.app` 或 `https://xxx.onrender.com`
2. **健康检查状态：** `/health` OK
3. **状态：** 已部署，API正常

**通知格式：**
```
后端已部署，/health OK，URL是 https://xxx.railway.app
```

---

## ⚠️ 重要提醒

1. **Root Directory必须设置为 `backend`**
   - Railway：在服务设置中配置
   - Render：在创建服务时配置

2. **环境变量必须配置**
   - `OTA_PID=284116645`（使用真实PID，不是TEST_PID）
   - `NODE_ENV=production`

3. **部署后立即验证**
   - 不要部署完就走
   - 必须验证所有API正常
   - 必须验证OTA链接正确

---

## 🔧 故障排查

### 部署失败
- 检查Root Directory是否正确
- 检查package.json是否存在
- 查看部署日志中的错误信息

### 服务无法启动
- 检查环境变量是否正确配置
- 检查日志中的错误信息
- 确认PORT是否正确

### 健康检查失败
- 检查服务是否正常运行
- 查看日志中的错误
- 确认网络连接正常

### OTA链接不正确
- 检查 `OTA_PID` 环境变量
- 确认PID是 `284116645`
- 检查链接生成逻辑

---

**开始时间：现在**
**预计时间：30-40分钟**
**状态：等待执行**

