# 生产环境配置指南

## 🔐 环境变量配置

### 前端环境变量（Vercel）

**配置位置：** Vercel项目设置 → Environment Variables

**需要配置的变量：**
```
NEXT_PUBLIC_API_URL=https://你的后端域名
```

**配置步骤：**
1. 登录Vercel
2. 选择项目
3. 进入Settings → Environment Variables
4. 添加变量：
   - Name: `NEXT_PUBLIC_API_URL`
   - Value: `https://你的后端域名`（后端部署后获取）
   - Environment: Production, Preview, Development（全选）

**注意事项：**
- 变量名必须以 `NEXT_PUBLIC_` 开头才能在客户端使用
- 更新环境变量后需要重新部署

---

### 后端环境变量（Railway/Render）

#### Railway配置

**配置位置：** Railway项目 → Variables

**需要配置的变量：**
```
OTA_PID=284116645
NODE_ENV=production
```

**配置步骤：**
1. 登录Railway
2. 选择项目
3. 进入Variables标签
4. 添加变量：
   - `OTA_PID`: `284116645`
   - `NODE_ENV`: `production`

**注意事项：**
- PORT会自动配置，无需手动设置
- 修改环境变量后会自动重新部署

#### Render配置

**配置位置：** Render服务 → Environment

**需要配置的变量：**
```
OTA_PID=284116645
NODE_ENV=production
```

**配置步骤：**
1. 登录Render
2. 选择服务
3. 进入Environment标签
4. 添加变量：
   - Key: `OTA_PID`, Value: `284116645`
   - Key: `NODE_ENV`, Value: `production`

**注意事项：**
- 修改环境变量后需要手动重新部署
- 确保变量值正确

---

## 🌐 域名配置（可选）

### 自定义域名

**前端（Vercel）：**
1. 进入项目设置 → Domains
2. 添加自定义域名
3. 配置DNS记录
4. 等待SSL证书自动配置

**后端（Railway/Render）：**
1. 进入服务设置
2. 配置自定义域名
3. 配置DNS记录
4. 等待SSL证书配置

**注意事项：**
- 免费套餐通常提供子域名
- 自定义域名需要购买
- SSL证书自动配置

---

## 📊 监控配置

### Google Analytics（推荐）

**配置步骤：**
1. 注册Google Analytics账号
2. 创建属性
3. 获取Measurement ID（如：G-XXXXXXXXXX）
4. 在Next.js中配置

**Next.js配置：**
```typescript
// frontend/app/layout.tsx
import Script from 'next/script'

export default function RootLayout({ children }) {
  return (
    <html>
      <head>
        <Script
          src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"
          strategy="afterInteractive"
        />
        <Script id="google-analytics" strategy="afterInteractive">
          {`
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'G-XXXXXXXXXX');
          `}
        </Script>
      </head>
      <body>{children}</body>
    </html>
  )
}
```

**监控指标：**
- 页面访问量
- 用户行为
- 转化事件（CTA点击）

---

### 简单日志监控（轻量方案）

**后端日志：**
```javascript
// 记录关键操作
console.log('API调用:', {
  endpoint: req.path,
  timestamp: new Date().toISOString(),
  ip: req.ip
})
```

**前端日志：**
```typescript
// 记录CTA点击
const handleCTAClick = (type: string) => {
  console.log('CTA点击:', {
    type,
    destination: destination.name,
    timestamp: new Date().toISOString()
  })
  // 跳转逻辑
}
```

---

## 🔍 必须监控的3个指标

### 1. 首页推荐卡CTR（点击率）

**计算方式：**
```
CTR = 点击推荐卡片的次数 / 访问首页的次数
```

**监控方法：**
- Google Analytics事件追踪
- 或简单日志记录

**目标：** ≥5%

---

### 2. CTA点击次数

**监控内容：**
- 每个CTA按钮的点击次数
- 哪个CTA点击最多
- 点击时间分布

**监控方法：**
- Google Analytics事件追踪
- 或后端日志记录

**目标：** 持续增长

---

### 3. 是否真实跳到OTA（哪怕只有1次）

**监控内容：**
- OTA链接是否正常跳转
- 链接是否包含正确PID
- 是否有用户完成跳转

**监控方法：**
- 检查服务器日志
- 检查OTA后台数据（如果有）
- 手动测试验证

**目标：** 至少1次成功跳转

---

## ⚠️ 安全配置

### CORS配置（后端）

**已配置：** 后端已启用CORS

**生产环境检查：**
```javascript
// 确保只允许生产域名
app.use(cors({
  origin: process.env.FRONTEND_URL || 'https://你的前端域名',
  credentials: true
}))
```

---

### 环境变量安全

**注意事项：**
1. **不要提交.env文件**
   - 已添加到.gitignore
   - 确保不会提交到Git

2. **使用平台环境变量管理**
   - Vercel环境变量
   - Railway/Render环境变量
   - 不要硬编码

3. **OTA PID保护**
   - 不要在前端代码中暴露
   - 只在后端使用
   - 定期检查是否泄露

---

## 📝 配置检查清单

### 前端配置
- [ ] Vercel项目已创建
- [ ] 环境变量已配置（NEXT_PUBLIC_API_URL）
- [ ] 部署成功
- [ ] 网站能正常访问

### 后端配置
- [ ] Railway/Render项目已创建
- [ ] 环境变量已配置（OTA_PID=284116645）
- [ ] 部署成功
- [ ] API能正常访问
- [ ] 健康检查通过

### 监控配置
- [ ] Google Analytics已配置（可选）
- [ ] 日志监控已配置
- [ ] 3个核心指标监控已设置

### 安全配置
- [ ] CORS配置正确
- [ ] 环境变量安全
- [ ] OTA PID未泄露

---

**配置完成后，进行生产环境验证**

