# 后端任务：信任信号动态更新

## 🎯 任务目标

实现信任信号的动态更新机制，让数据"动起来"，避免长期使用静态数据。

---

## 📋 任务要求

### 核心要求
1. **每天自动更新**
   - 使用定时任务（cron）
   - 每天凌晨执行
   - 更新所有目的地的信任信号数据

2. **更新规则：**
   - 点击量（click_count_7d）：每天+1~5（随机）
   - 已选人数（student_count）：每天+1~3（随机）
   - 热门度标记（is_popular）：根据点击量自动调整

3. **数据存储：**
   - 更新到数据文件（data/destinations.json）
   - 保持数据格式不变

---

## 🔧 实现方案

### 方案1：使用Node-cron（推荐）

#### 步骤1：安装依赖

```bash
cd backend
npm install node-cron
```

#### 步骤2：创建更新函数

在 `backend/server.js` 中添加：

```javascript
const cron = require('node-cron');
const fs = require('fs');
const path = require('path');

// 更新信任信号数据
function updateTrustSignals() {
  try {
    const dataPath = path.join(__dirname, '../data/destinations.json');
    const destinations = JSON.parse(fs.readFileSync(dataPath, 'utf8'));
    
    destinations.forEach(dest => {
      // 点击量 +1~5（随机）
      const clickIncrease = Math.floor(Math.random() * 5) + 1;
      dest.trust_signals.click_count_7d += clickIncrease;
      
      // 已选人数 +1~3（随机）
      const studentIncrease = Math.floor(Math.random() * 3) + 1;
      dest.trust_signals.student_count += studentIncrease;
      
      // 更新热门度标记（如果点击量超过100）
      if (dest.trust_signals.click_count_7d > 100) {
        dest.trust_signals.is_popular = true;
      }
      
      // 更新"最近7天点击最多"标记（前3名）
      // 这个在返回数据时动态计算，不需要在这里更新
    });
    
    // 保存更新后的数据
    fs.writeFileSync(dataPath, JSON.stringify(destinations, null, 2), 'utf8');
    
    console.log(`[${new Date().toISOString()}] 信任信号已更新:`, {
      updated: destinations.length,
      timestamp: new Date().toISOString()
    });
  } catch (error) {
    console.error('更新信任信号失败:', error);
  }
}

// 每天凌晨2点执行
cron.schedule('0 2 * * *', () => {
  updateTrustSignals();
});

// 开发环境：每5分钟执行一次（用于测试）
if (process.env.NODE_ENV !== 'production') {
  console.log('开发环境：信任信号更新任务每5分钟执行一次');
  cron.schedule('*/5 * * * *', () => {
    updateTrustSignals();
  });
}
```

#### 步骤3：测试

**测试方法：**
1. 启动后端服务
2. 等待5分钟（开发环境）
3. 检查 `data/destinations.json` 文件
4. 确认数据已更新

**验证：**
- [ ] 点击量已增加
- [ ] 已选人数已增加
- [ ] 数据格式正确
- [ ] 没有错误

---

### 方案2：使用云服务定时任务

**Railway/Render：**
- 使用平台的cron job功能
- 或使用外部cron服务（如cron-job.org）

---

## 📊 更新规则说明

### 点击量更新
- **规则：** 每天+1~5（随机）
- **原因：** 模拟自然增长，不会增长过快
- **范围：** 1-5之间随机

### 已选人数更新
- **规则：** 每天+1~3（随机）
- **原因：** 模拟学生选择，增长较慢
- **范围：** 1-3之间随机

### 热门度标记
- **规则：** 如果点击量>100，标记为热门
- **原因：** 动态调整热门度
- **更新：** 自动更新

---

## ⚠️ 注意事项

### 数据安全
1. **备份数据**
   - 更新前备份原数据
   - 防止更新失败导致数据丢失

2. **错误处理**
   - 更新失败时记录错误
   - 不影响服务正常运行

3. **数据格式**
   - 保持JSON格式正确
   - 保持数据结构不变

### 更新频率
1. **生产环境：** 每天凌晨2点执行一次
2. **开发环境：** 每5分钟执行一次（用于测试）

### 更新范围
- 更新所有20个城市
- 保持数据一致性

---

## ✅ 验收标准

### 功能验收
- [ ] 定时任务正常运行
- [ ] 数据每天自动更新
- [ ] 更新规则合理（不会增长过快）
- [ ] 错误处理完善

### 数据验收
- [ ] 点击量正常增长
- [ ] 已选人数正常增长
- [ ] 热门度标记正确
- [ ] 数据格式正确

### 测试验收
- [ ] 开发环境测试通过
- [ ] 生产环境配置正确
- [ ] 定时任务正常运行

---

## 📝 实现检查清单

### 开发阶段
- [ ] 安装node-cron依赖
- [ ] 创建更新函数
- [ ] 配置定时任务
- [ ] 测试更新功能
- [ ] 验证数据更新

### 部署阶段
- [ ] 确保定时任务在生产环境运行
- [ ] 验证更新规则
- [ ] 监控更新日志

---

## 🎯 关键提醒

1. **不要追求真实数据**
   - 重点是让数据"动起来"
   - 不需要真实用户数据
   - 只要避免用户发现数据不更新

2. **更新规则要合理**
   - 不要增长过快（显得不真实）
   - 不要增长过慢（用户会发现）
   - 保持自然增长

3. **错误处理要完善**
   - 更新失败不影响服务
   - 记录错误日志
   - 便于排查问题

---

**创建时间：现在**
**实现时间：上线前或上线后第1天**
**优先级：高**


